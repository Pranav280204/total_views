<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MrBeast Total Views (IST)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --accent: #0b62ff;
      --accent-dark: #054ecc;
      --bg: #ffffff;
      --card: #f8fbff;
      --muted: #222222;
      --positive: #16a34a;
      --negative: #e11d48;
      --table-border: rgba(0,0,0,0.08);
    }
    html,body{margin:0;padding:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--muted);}
    .container{max-width:1100px;margin:36px auto;padding:18px;}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(13,38,79,0.06);border:1px solid rgba(11,98,255,0.06);}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    h1{margin:0;font-size:20px;color:var(--accent-dark);}
    .summary{display:flex;gap:20px;align-items:center;flex-wrap:wrap;margin-top:12px;margin-bottom:18px;justify-content:space-between;}
    .left{display:flex;gap:18px;align-items:center;flex-wrap:wrap;}
    .total{font-size:36px;font-weight:700;color:#000;}
    .last-update{font-size:13px;color:#444;}
    .controls{display:flex;gap:10px;align-items:center;}
    button, select, input {border-radius:8px;padding:8px 12px;border:1px solid rgba(0,0,0,0.08);font-size:14px;cursor:pointer;background:white;color:#111;}
    button.primary{background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;border:none;}
    button.ghost{background:transparent;border:1px solid rgba(11,98,255,0.12);color:var(--accent-dark);}
    .note{margin-top:12px;color:#444;font-size:13px;}
    table{width:100%;border-collapse:collapse;margin-top:16px;background:white;border-radius:8px;overflow:hidden;}
    th, td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--table-border);font-size:14px;}
    thead th{font-size:12px;color:#0b62ff;text-transform:uppercase;letter-spacing:0.6px;}
    td.num{font-variant-numeric:tabular-nums;}
    .gain-positive{color:var(--positive);font-weight:700;}
    .gain-negative{color:var(--negative);font-weight:700;}
    .muted{color:#666;font-size:13px;}
    .top-row{display:flex;gap:12px;align-items:center;}
    .target-box{display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:#fff;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);}
    .small{font-size:13px;color:#444;}
    @media (max-width:700px){.summary{flex-direction:column;align-items:flex-start;gap:8px}.controls{width:100%;justify-content:flex-start;}}
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <header>
        <div>
          <h1>MrBeast — Total Views (IST)</h1>
          <div class="muted">Automatic snapshots at exact :00, :10, :20, :30, :40, :50 (every 10 minutes IST)</div>
        </div>

        <div class="controls">
          <button class="primary" onclick="refreshAll()">Refresh</button>
          <button class="ghost" onclick="triggerSnapshot()">Take snapshot now</button>
        </div>
      </header>

      <div class="summary">
        <div class="left">
          <div>
            <div class="total" id="totalViews">Loading…</div>
            <div class="last-update" id="lastUpdate">—</div>
          </div>

          <div style="min-width:240px;">
            <label class="muted" style="display:block;margin-bottom:6px;">Set target (total views) &amp; target date/time (IST)</label>
            <div class="target-box">
              <input id="targetInput" type="number" placeholder="Target total views">
              <input id="targetTimeInput" type="datetime-local">
              <button onclick="setTarget()">Set Target</button>
            </div>
            <div class="small" style="margin-top:6px;">Times entered are interpreted as Asia/Kolkata (IST).</div>
          </div>
        </div>

        <div class="muted" id="infoRight">Snapshots stored every 10 minutes (aligned)</div>
      </div>

      <div id="error" style="color:#ef4444;display:none;margin-bottom:10px;"></div>

      <div style="display:flex;gap:18px;flex-wrap:wrap;">
        <div style="flex:1;min-width:280px;">
          <table>
            <thead>
              <tr><th>Metric</th><th>Value</th></tr>
            </thead>
            <tbody id="metricsBody">
              <tr><td>Required per 10-min</td><td id="req10">—</td></tr>
              <tr><td>Required per day</td><td id="reqDay">—</td></tr>
              <tr><td>Remaining needed</td><td id="remNeed">—</td></tr>
              <tr><td>Time remaining</td><td id="timeRem">—</td></tr>
            </tbody>
          </table>
        </div>

        <div style="flex:1;min-width:320px;">
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
            <div class="muted">Daily summary (most recent)</div>
            <div>
              <label class="muted" style="margin-right:8px;">View day:</label>
              <select id="daySelect" onchange="loadForDay()">
                <option value="">— Select day —</option>
              </select>
              <button onclick="clearDay()">All</button>
            </div>
          </div>

          <div id="dailyView">
            <table id="dailyTable">
              <thead>
                <tr>
                  <th>Day (IST)</th>
                  <th>First total</th>
                  <th>Last total</th>
                  <th>Gain (day)</th>
                  <th>Snapshots</th>
                </tr>
              </thead>
              <tbody id="dailyBody">
                <tr><td colspan="5">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <div id="daySnapshots" style="display:none;margin-top:12px;">
            <table id="snapTable">
              <thead>
                <tr>
                  <th>Time (IST)</th>
                  <th>Total Views</th>
                  <th>Gain</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr><td colspan="3">Loading…</td></tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="note">Use the day selector to view daily aggregates or drill down into snapshots for a particular day. Required rates auto-update with each refresh.</div>
      </div>
    </div>
  </div>

  <script>
    const totalEl = document.getElementById("totalViews");
    const lastUpdateEl = document.getElementById("lastUpdate");
    const req10El = document.getElementById("req10");
    const reqDayEl = document.getElementById("reqDay");
    const remNeedEl = document.getElementById("remNeed");
    const timeRemEl = document.getElementById("timeRem");
    const targetInput = document.getElementById("targetInput");
    const targetTimeInput = document.getElementById("targetTimeInput");
    const dailyBody = document.getElementById("dailyBody");
    const daySelect = document.getElementById("daySelect");
    const tableBody = document.getElementById("tableBody");
    const daySnapshots = document.getElementById("daySnapshots");
    const errorEl = document.getElementById("error");

    function formatDuration(seconds){
      if (seconds <= 0) return "0s";
      const days = Math.floor(seconds / 86400); seconds %= 86400;
      const hours = Math.floor(seconds / 3600); seconds %= 3600;
      const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60);
      let parts = [];
      if (days) parts.push(days + "d");
      if (hours) parts.push(hours + "h");
      if (mins) parts.push(mins + "m");
      if (secs && parts.length === 0) parts.push(secs + "s");
      return parts.join(" ");
    }

    function formatIST(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        hour12: true,
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });
    }

    async function loadTotal(){
      try {
        const res = await fetch("/total");
        const data = await res.json();
        if (data.total_views !== null) {
          totalEl.innerText = Number(data.total_views).toLocaleString();
        } else {
          totalEl.innerText = "—";
        }
      } catch (e) {
        totalEl.innerText = "—";
      }
    }

    async function loadDaily(){
      dailyBody.innerHTML = "<tr><td colspan='5'>Loading…</td></tr>";
      try {
        const res = await fetch("/daily");
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          dailyBody.innerHTML = "<tr><td colspan='5'>No daily data yet</td></tr>";
          return;
        }
        dailyBody.innerHTML = "";
        daySelect.innerHTML = "<option value=''>— Select day —</option>";
        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row.day}</td>
                          <td class="num">${Number(row.first_total).toLocaleString()}</td>
                          <td class="num">${Number(row.last_total).toLocaleString()}</td>
                          <td class="num ${row.daily_gain>=0?'gain-positive':'gain-negative'}">${(row.daily_gain>=0?'+':'')+Number(row.daily_gain).toLocaleString()}</td>
                          <td>${row.snaps}</td>`;
          dailyBody.appendChild(tr);

          const opt = document.createElement("option");
          opt.value = row.day;
          opt.innerText = row.day + " (" + row.snaps + ")";
          daySelect.appendChild(opt);
        });
      } catch (e) {
        dailyBody.innerHTML = "<tr><td colspan='5'>Failed to load daily data</td></tr>";
      }
    }

    async function loadHistory(day) {
      tableBody.innerHTML = "<tr><td colspan='3'>Loading…</td></tr>";
      try {
        const url = day ? `/history?day=${day}` : "/history";
        const res = await fetch(url);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          tableBody.innerHTML = "<tr><td colspan='3'>No snapshots for this day</td></tr>";
          return;
        }

        tableBody.innerHTML = "";
        data.forEach(row => {
          const tr = document.createElement("tr");

          const timeTd = document.createElement("td");
          timeTd.innerText = formatIST(row.ts);

          const totalTd = document.createElement("td");
          totalTd.className = "num";
          totalTd.innerText = Number(row.total_views).toLocaleString();

          const gainTd = document.createElement("td");
          gainTd.className = "num";
          if (row.view_gain === null) {
            gainTd.innerText = "—";
          } else {
            const g = Number(row.view_gain);
            gainTd.innerText = (g >= 0 ? "+" : "") + g.toLocaleString();
            gainTd.classList.add(g >= 0 ? "gain-positive" : "gain-negative");
          }

          tr.appendChild(timeTd);
          tr.appendChild(totalTd);
          tr.appendChild(gainTd);
          tableBody.appendChild(tr);
        });

        lastUpdateEl.innerText = "Last snapshot: " + formatIST(data[0].ts);

      } catch (e) {
        tableBody.innerHTML = "<tr><td colspan='3'>Failed to load snapshots</td></tr>";
      }
    }

    async function loadTarget(){
      try {
        const res = await fetch("/target");
        const data = await res.json();
        if (data) {
          targetInput.value = data.target_total;
          const dt = new Date(data.target_ts);
          const pad = v => String(v).padStart(2,'0');
          const y = dt.getFullYear(), m = pad(dt.getMonth()+1), d = pad(dt.getDate());
          const hh = pad(dt.getHours()), mm = pad(dt.getMinutes());
          targetTimeInput.value = `${y}-${m}-${d}T${hh}:${mm}`;
        }
      } catch (e) {}
    }

    async function setTarget(){
      errorEl.style.display = "none";
      const total = targetInput.value;
      const ts = targetTimeInput.value;
      if (!total || !ts) {
        errorEl.innerText = "Provide both target total and target date/time.";
        errorEl.style.display = "block";
        return;
      }

      try {
        const res = await fetch("/target", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ target_total: Number(total), target_ts: ts })
        });
        const data = await res.json();
        if (res.ok) {
          await refreshAll();
        } else {
          errorEl.innerText = data.error || JSON.stringify(data);
          errorEl.style.display = "block";
        }
      } catch (e) {
        errorEl.innerText = "Failed to set target";
        errorEl.style.display = "block";
      }
    }

    async function loadRequired(){
      try {
        const res = await fetch("/required");
        const data = await res.json();
        if (data.status === "missing_target") {
          req10El.innerText = "No target set";
          reqDayEl.innerText = "No target set";
          remNeedEl.innerText = "—";
          timeRemEl.innerText = "—";
          return;
        }
        if (data.status === "no_snapshot") {
          req10El.innerText = "No snapshots";
          reqDayEl.innerText = "No snapshots";
          remNeedEl.innerText = "—";
          timeRemEl.innerText = "—";
          return;
        }
        if (data.status === "passed") {
          req10El.innerText = "Target reached ✓";
          reqDayEl.innerText = "Target reached ✓";
        } else if (data.status === "deadline_passed") {
          req10El.innerText = "Deadline passed";
          reqDayEl.innerText = "Deadline passed";
        } else {
          req10El.innerText = Number(data.per_10min_required).toLocaleString();
          reqDayEl.innerText = Number(data.per_day_required).toLocaleString();
        }
        remNeedEl.innerText = data.remaining_needed > 0 ? Number(data.remaining_needed).toLocaleString() : (data.remaining_needed === 0 ? "0" : Number(data.remaining_needed).toLocaleString());
        timeRemEl.innerText = data.seconds_remaining ? formatDuration(data.seconds_remaining) : "—";
      } catch (e) {
        req10El.innerText = "—";
        reqDayEl.innerText = "—";
      }
    }

    async function triggerSnapshot(){
      try {
        const res = await fetch("/snapshot", { method: "POST" });
        const data = await res.json();
        if (data.status === "ok") {
          await refreshAll();
        } else {
          errorEl.innerText = "Snapshot returned unexpected response";
          errorEl.style.display = "block";
        }
      } catch (e) {
        errorEl.innerText = "Snapshot trigger failed";
        errorEl.style.display = "block";
      }
    }

    async function refreshAll(){
      errorEl.style.display = "none";
      await loadTotal();
      await loadDaily();
      await loadTarget();
      await loadRequired();
      // if day is selected, refresh snapshots table
      if (daySelect.value) {
        showDaySnapshots();
        await loadHistory(daySelect.value);
      } else {
        hideDaySnapshots();
      }
    }

    function showDaySnapshots(){
      daySnapshots.style.display = "block";
    }
    function hideDaySnapshots(){
      daySnapshots.style.display = "none";
    }

    async function loadForDay(){
      const selected = daySelect.value;
      if (!selected) {
        hideDaySnapshots();
        return;
      }
      showDaySnapshots();
      await loadHistory(selected);
    }
    function clearDay(){
      daySelect.value = "";
      hideDaySnapshots();
    }

    // initial load
    refreshAll();
    setInterval(refreshAll, 60 * 1000);
  </script>
</body>
</html>
