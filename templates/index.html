<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MrBeast Total Views (IST)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --accent: #0b62ff;
      --accent-dark: #054ecc;
      --bg: #ffffff;
      --card: #f8fbff;
      --muted: #222222;
      --positive: #16a34a;
      --negative: #e11d48;
      --table-border: rgba(0,0,0,0.08);
    }
    html,body{margin:0;padding:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--muted);}
    .container{max-width:1100px;margin:36px auto;padding:18px;}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(13,38,79,0.06);border:1px solid rgba(11,98,255,0.06);}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    h1{margin:0;font-size:20px;color:var(--accent-dark);}
    .summary{display:flex;gap:20px;align-items:center;flex-wrap:wrap;margin-top:12px;margin-bottom:18px;justify-content:space-between;}
    .left{display:flex;gap:18px;align-items:center;flex-wrap:wrap;}
    .total{font-size:36px;font-weight:700;color:#000;}
    .last-update{font-size:13px;color:#444;}
    .controls{display:flex;gap:10px;align-items:center;}
    button, select, input {border-radius:8px;padding:8px 12px;border:1px solid rgba(0,0,0,0.08);font-size:14px;cursor:pointer;background:white;color:#111;}
    button.primary{background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;border:none;}
    button.ghost{background:transparent;border:1px solid rgba(11,98,255,0.12);color:var(--accent-dark);}
    .note{margin-top:12px;color:#444;font-size:13px;}
    .flex{display:flex;gap:12px;align-items:center;}
    table{width:100%;border-collapse:collapse;margin-top:16px;background:white;border-radius:8px;overflow:hidden;}
    th, td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--table-border);font-size:14px;}
    thead th{font-size:12px;color:#0b62ff;text-transform:uppercase;letter-spacing:0.6px;}
    td.num{font-variant-numeric:tabular-nums;}
    .gain-positive{color:var(--positive);font-weight:700;}
    .gain-negative{color:var(--negative);font-weight:700;}
    .muted{color:#666;font-size:13px;}
    .top-row{display:flex;gap:12px;align-items:center;}
    .small{font-size:13px;color:#444;}
    #daySnapshots { max-height: 380px; overflow: auto; border-radius: 6px; }
    @media (max-width:700px){.summary{flex-direction:column;align-items:flex-start;gap:8px}.controls{width:100%;justify-content:flex-start}}
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <header>
        <div>
          <h1>MrBeast — Total Views (IST)</h1>
          <div class="muted">Automatic snapshots at exact :00, :10, :20, :30, :40, :50 (every 10 minutes IST)</div>
        </div>

        <div class="controls">
          <button class="primary" onclick="refreshAll()">Refresh</button>
          <button class="ghost" onclick="triggerSnapshot()">Take snapshot now</button>
        </div>
      </header>

      <div class="summary">
        <div class="left">
          <div>
            <div class="total" id="totalViews">Loading…</div>
            <div class="last-update" id="lastUpdate">—</div>
          </div>

          <div style="min-width:320px;">
            <label class="muted" style="display:block;margin-bottom:6px;">View day (IST)</label>
            <div class="flex">
              <select id="daySelect" onchange="loadForDay()">
                <option value="">— Select day —</option>
              </select>
              <button onclick="clearDay()">Show all</button>
            </div>
            <div class="small" style="margin-top:6px;">Page defaults to today's data and shows the last ~20 minutes on open.</div>
          </div>
        </div>

        <div class="muted" id="infoRight">Snapshots stored every 10 minutes (aligned)</div>
      </div>

      <div id="error" style="color:#ef4444;display:none;margin-bottom:10px;"></div>

      <div style="display:flex;gap:18px;flex-wrap:wrap;">
        <div style="flex:1;min-width:320px;">
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
            <div class="muted">Daily summary (most recent)</div>
            <div class="muted small">Use the selector to drill down</div>
          </div>

          <div id="dailyView">
            <table id="dailyTable">
              <thead>
                <tr>
                  <th>Day (IST)</th>
                  <th>First total</th>
                  <th>Last total</th>
                  <th>Gain (day)</th>
                  <th>Snapshots</th>
                </tr>
              </thead>
              <tbody id="dailyBody">
                <tr><td colspan="5">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div style="flex:1;min-width:420px;">
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
            <div class="muted">Snapshots for selected day</div>
            <div class="muted small" id="snapHint">Showing recent snapshots</div>
          </div>

          <div id="daySnapshots">
            <table id="snapTable">
              <thead>
                <tr>
                  <th>Time (IST)</th>
                  <th>Total Views</th>
                  <th>Gain</th>
                  <th>Hourly Gain</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr><td colspan="4">Loading…</td></tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="note">Hourly Gain is (current snapshot) − (snapshot 1 hour earlier). If exact 1-hour-prior snapshot isn't found, the server looks ±5s, then the nearest snapshot within 10 minutes and marks it approximate.</div>
      </div>
    </div>
  </div>

  <script>
    const totalEl = document.getElementById("totalViews");
    const lastUpdateEl = document.getElementById("lastUpdate");
    const dailyBody = document.getElementById("dailyBody");
    const daySelect = document.getElementById("daySelect");
    const tableBody = document.getElementById("tableBody");
    const daySnapshots = document.getElementById("daySnapshots");
    const snapHint = document.getElementById("snapHint");
    const errorEl = document.getElementById("error");

    // helper to format IST timestamps nicely
    function formatIST(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        hour12: true,
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });
    }

    // helper to keep scroll position stable while updating content
    function preserveScrollAndUpdate(containerEl, updateFn) {
      const scrollTop = containerEl.scrollTop;
      updateFn();
      // restore after a tiny delay to let DOM update
      setTimeout(() => { containerEl.scrollTop = scrollTop; }, 10);
    }

    async function loadTotal(){
      try {
        const res = await fetch("/total");
        const data = await res.json();
        if (data.total_views !== null) {
          totalEl.innerText = Number(data.total_views).toLocaleString();
          lastUpdateEl.innerText = data.ts ? "Last snapshot: " + formatIST(data.ts) : "";
        } else {
          totalEl.innerText = "—";
          lastUpdateEl.innerText = "—";
        }
      } catch (e) {
        totalEl.innerText = "—";
        lastUpdateEl.innerText = "—";
      }
    }

    async function loadDaily(){
      // update daily summary; preserve scroll of its container (if any)
      try {
        const res = await fetch("/daily");
        const data = await res.json();
        dailyBody.innerHTML = "";
        if (!Array.isArray(data) || data.length === 0) {
          dailyBody.innerHTML = "<tr><td colspan='5'>No daily data yet</td></tr>";
          return;
        }
        // build rows
        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row.day}</td>
                          <td class="num">${Number(row.first_total).toLocaleString()}</td>
                          <td class="num">${Number(row.last_total).toLocaleString()}</td>
                          <td class="num ${row.daily_gain>=0?'gain-positive':'gain-negative'}">${(row.daily_gain>=0?'+':'')+Number(row.daily_gain).toLocaleString()}</td>
                          <td>${row.snaps}</td>`;
          dailyBody.appendChild(tr);
        });

        // populate day selector (most recent first)
        daySelect.innerHTML = "<option value=''>— Select day —</option>";
        data.forEach(row => {
          const opt = document.createElement("option");
          opt.value = row.day;
          opt.innerText = row.day + " (" + row.snaps + ")";
          daySelect.appendChild(opt);
        });

        // auto-select today's date on initial load if available
        const today = new Date().toLocaleDateString('en-CA', {timeZone: 'Asia/Kolkata'}); // YYYY-MM-DD
        // If the selector contains today's date, set it and load that day's snapshots (priority to date data)
        const opts = Array.from(daySelect.options).map(o => o.value);
        if (opts.includes(today)) {
          daySelect.value = today;
          await loadForDay(); // load today's snapshots and show last ~20min
        } else {
          // otherwise show the most recent day automatically
          if (data.length > 0) {
            daySelect.value = data[0].day;
            await loadForDay();
          }
        }

      } catch (e) {
        dailyBody.innerHTML = "<tr><td colspan='5'>Failed to load daily data</td></tr>";
      }
    }

    async function loadHistoryForDay(day) {
      // preserve scroll position of the daySnapshots container to avoid jumpiness
      preserveScrollAndUpdate(daySnapshots, async () => {
        tableBody.innerHTML = "<tr><td colspan='4'>Loading…</td></tr>";
        try {
          const url = day ? `/history?day=${day}` : "/history";
          const res = await fetch(url);
          const data = await res.json();

          if (!Array.isArray(data) || data.length === 0) {
            tableBody.innerHTML = "<tr><td colspan='4'>No snapshots for this day</td></tr>";
            return;
          }

          // Show only last ~20 minutes worth on open: last 2 snapshots (10min interval) — but allow full view if user scrolls
          // We display all rows but we will scroll to show the last 2 (most recent) visible on top.
          tableBody.innerHTML = "";
          data.forEach((row, idx) => {
            const tr = document.createElement("tr");

            const timeTd = document.createElement("td");
            timeTd.innerText = formatIST(row.ts);

            const totalTd = document.createElement("td");
            totalTd.className = "num";
            totalTd.innerText = Number(row.total_views).toLocaleString();

            const gainTd = document.createElement("td");
            gainTd.className = "num";
            if (row.view_gain === null) {
              gainTd.innerText = "—";
            } else {
              const g = Number(row.view_gain);
              gainTd.innerText = (g >= 0 ? "+" : "") + g.toLocaleString();
              gainTd.classList.add(g >= 0 ? "gain-positive" : "gain-negative");
            }

            const hrTd = document.createElement("td");
            hrTd.className = "num";
            if (row.hourly_gain === null) {
              hrTd.innerText = "—";
            } else {
              const hg = Number(row.hourly_gain);
              hrTd.innerText = (hg >= 0 ? "+" : "") + hg.toLocaleString();
              hrTd.classList.add(hg >= 0 ? "gain-positive" : "gain-negative");
              if (row.hourly_approx) {
                hrTd.innerText += " *"; // mark approximate
              }
            }

            tr.appendChild(timeTd);
            tr.appendChild(totalTd);
            tr.appendChild(gainTd);
            tr.appendChild(hrTd);
            tableBody.appendChild(tr);
          });

          // Auto-scroll to show most recent ~20 minutes (last 2 snapshots) at top of scrolling viewport
          // Only do this when a day was explicitly selected or on initial page open.
          // Find last rows height and set scrollTop accordingly.
          // small timeout to allow DOM size to settle
          setTimeout(() => {
            try {
              // compute position to show last 2 rows
              const rows = tableBody.querySelectorAll("tr");
              const visibleCount = 2; // show ~20 minutes => 2 snapshots (10-min interval)
              if (rows.length > visibleCount) {
                const targetRow = rows[visibleCount - 1]; // keep top such that last rows are visible
                daySnapshots.scrollTop = targetRow.offsetTop - 8;
              } else {
                daySnapshots.scrollTop = 0;
              }
            } catch (e) { /* ignore scroll calc errors */ }
          }, 40);

        } catch (e) {
          tableBody.innerHTML = "<tr><td colspan='4'>Failed to load snapshots</td></tr>";
        }
      });
    }

    async function loadForDay() {
      const selected = daySelect.value;
      if (!selected) {
        // show all recent snapshots (default table)
        await loadHistoryForDay("");
        snapHint.innerText = "Showing recent snapshots (all days)";
        return;
      }
      snapHint.innerText = "Showing snapshots for " + selected;
      await loadHistoryForDay(selected);
    }

    function clearDay(){
      daySelect.value = "";
      loadForDay();
    }

    async function triggerSnapshot(){
      try {
        const res = await fetch("/snapshot", { method: "POST" });
        const data = await res.json();
        if (data.status === "ok") {
          await refreshAll();
        } else {
          errorEl.innerText = "Snapshot returned unexpected response";
          errorEl.style.display = "block";
        }
      } catch (e) {
        errorEl.innerText = "Snapshot trigger failed";
        errorEl.style.display = "block";
      }
    }

    // refresh limited parts (do not replace full DOM), preserve scroll positions
    async function refreshAll(){
      errorEl.style.display = "none";
      await loadTotal();
      await loadDaily();
      // If a specific day is selected, refresh its history (and keep scroll)
      if (daySelect.value) {
        await loadForDay();
      } else {
        // show most recent day's data by default (loadForDay handles auto-select on daily load)
      }
    }

    // first load
    (async () => {
      await refreshAll();
      // periodic refresh: update totals & daily summary & current day snapshots without resetting scroll
      setInterval(async () => {
        // update in small pieces
        await loadTotal();
        // update daily summary (will not change selected day unless selector data changes)
        await loadDaily();
        if (daySelect.value) {
          await loadForDay();
        }
      }, 60 * 1000); // every 60s
    })();

  </script>
</body>
</html>
